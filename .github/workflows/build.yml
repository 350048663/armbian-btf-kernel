# This is a basic workflow to help you get started with Actions

name: CI

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
        matrix:
          include:
            - boardfamily: meson64
              branch: edge
              representative: aml-s9xx-box
        fail-fast: false
    runs-on: kix
    env:
      BOARD_FAMILY: ${{ matrix.boardfamily }}
      BRANCH: ${{ matrix.branch }}
      BOARD_NAME: ${{ matrix.representative }}

    steps:
      - uses: actions/checkout@v3
        with:
          repository: armbian/build
      
      - uses: actions/checkout@v3
        with:
          path: utils

      - name: Build Kernel
        run: |
          # Copy helper files.
          cp utils/{merge_config.sh,.config-btf} ./

          # Remove disabling DEBUG_INFO.
          sed -i 's/run_kernel_make olddefconfig/run_kernel_make KCONFIG_ALLCONFIG=.config alldefconfig/g' lib/functions/compilation/kernel-config.sh
          sed -i '/kernel_config_set_n DEBUG_INFO/d' lib/functions/compilation/armbian-kernel.sh

          # Enable BTF
          mv config/kernel/linux-"$BOARD_FAMILY"-"$BRANCH".config .config
          sh merge_config.sh -m .config .config-btf
          mv .config config/kernel/linux-"$BOARD_FAMILY"-"$BRANCH".config

          # Compile kernel.
          ./compile.sh RELEASE=jammy JUST_KERNEL=yes KERNEL_ONLY=yes BOARD="$BOARD_NAME" BRANCH="$BRANCH" KERNEL_CONFIGURE=no

      - name: Extract vmlinux
        id: vmlinux
        run: |
          filename=output_"$BOARD_FAMILY"_"$BRANCH"_"$BOARD_NAME".tar
          tar -cf "$filename" output
          echo FILENAME=output_"$BOARD_FAMILY"_"$BRANCH"_"$BOARD_NAME".zip >> $GITHUB_OUTPUT
          echo FILEPATH="$(realpath ${filename})" >> $GITHUB_OUTPUT
          
          #cd output/debs/
          #fname=$(ls --format single-column linux-image-*.deb | head -n 1)
          #id=$(echo $fname | cut -d- -f3-4)
          #dpkg-deb -x "$fname" kernel
          #filename=vmlinux_"$BOARD_FAMILY"_"$id"
          #vmlinux_file_src=$(ls --format single-column kernel/boot/vmlinux* | head -n 1)
          #cp "$vmlinux_file_src" "$filename"
          #echo FILEPATH="$(realpath ${filename})" >> $GITHUB_OUTPUT

      - name: Upload files to Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.vmlinux.outputs.FILENAME }}
          path: ${{ steps.vmlinux.outputs.FILEPATH }}
